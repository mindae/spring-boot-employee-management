# Flyway Database Migration Guide

This guide explains the database migration setup using Flyway for the Spring Boot Employee Management System.

## 📋 Overview

Flyway is now used to manage database schema and data migrations, replacing the previous approach of using Hibernate DDL and Java-based initialization.

## 🗂️ Migration Structure

```
src/main/resources/db/migration/
├── V1__Create_User_Tables.sql          # User authentication tables
├── V2__Create_Employee_Table.sql       # Employee management table
├── V3__Insert_Default_Users.sql        # Default users and authorities
└── V4__Insert_Sample_Employees.sql     # Sample employee data
```

## 📊 Migration Details

### **V1__Create_User_Tables.sql**
- **Purpose**: Creates user authentication tables
- **Tables**: `APP_USERS`, `APP_AUTHORITIES`
- **Features**: 
  - Primary keys with auto-increment
  - Foreign key relationships
  - Indexes for performance
  - Comprehensive documentation

### **V2__Create_Employee_Table.sql**
- **Purpose**: Creates employee management table
- **Tables**: `EMPLOYEES`
- **Features**:
  - Employee information fields
  - Performance indexes
  - Column documentation

### **V3__Insert_Default_Users.sql**
- **Purpose**: Inserts default users for testing
- **Users**: `user`, `admin`, `bill`
- **Passwords**: BCrypt encrypted (same as username)
- **Roles**: 
  - `user`: ROLE_USER
  - `admin`: ROLE_USER, ROLE_ADMIN
  - `bill`: ROLE_ADMIN

### **V4__Insert_Sample_Employees.sql**
- **Purpose**: Inserts sample employee data
- **Data**: 10 sample employees with various roles
- **Features**: Realistic test data for development

## ⚙️ Configuration

### **Application Properties**
```properties
# Flyway Configuration
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true
spring.flyway.validate-on-migrate=true
spring.flyway.clean-disabled=true
spring.flyway.out-of-order=false

# JPA/Hibernate Configuration
spring.jpa.hibernate.ddl-auto=validate
```

### **Key Configuration Options**
- `spring.flyway.enabled=true`: Enables Flyway
- `spring.flyway.locations`: Migration file location
- `spring.flyway.baseline-on-migrate=true`: Creates baseline for existing databases
- `spring.flyway.validate-on-migrate=true`: Validates migrations before running
- `spring.flyway.clean-disabled=true`: Prevents accidental data loss
- `spring.flyway.out-of-order=false`: Ensures migrations run in order

## 🚀 Benefits of Flyway Migration

### **Separation of Concerns**
- ✅ **Database schema** managed separately from application code
- ✅ **Version control** for database changes
- ✅ **Rollback capability** for database changes
- ✅ **Environment consistency** across dev, test, prod

### **Improved Development**
- ✅ **No more SQL in Java code**
- ✅ **Clear migration history**
- ✅ **Automated database setup**
- ✅ **Team collaboration** on database changes

### **Production Benefits**
- ✅ **Safe deployments** with validation
- ✅ **Audit trail** of all database changes
- ✅ **Rollback capability** if needed
- ✅ **Zero-downtime migrations** (when possible)

## 📝 Migration Naming Convention

```
V{version}__{Description}.sql
```

**Examples:**
- `V1__Create_User_Tables.sql`
- `V2__Create_Employee_Table.sql`
- `V3__Insert_Default_Users.sql`

## 🔧 Adding New Migrations

### **Step 1: Create Migration File**
```bash
# Create new migration file
touch src/main/resources/db/migration/V5__Add_New_Feature.sql
```

### **Step 2: Write Migration SQL**
```sql
-- V5__Add_New_Feature.sql
-- Description: Add new feature table
-- Author: Your Name
-- Date: YYYY-MM-DD

CREATE TABLE NEW_FEATURE (
    ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL,
    DESCRIPTION VARCHAR2(500),
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### **Step 3: Test Migration**
```bash
# Run application to test migration
mvn spring-boot:run
```

## 🧪 Testing Migrations

### **Local Testing**
```bash
# Clean database and test migrations
mvn flyway:clean
mvn flyway:migrate
mvn spring-boot:run
```

### **Docker Testing**
```bash
# Test with Docker
docker-compose down -v  # Remove volumes
docker-compose up --build
```

## 📚 Migration Best Practices

### **Do's**
- ✅ **Use descriptive names** for migration files
- ✅ **Include comments** explaining the purpose
- ✅ **Test migrations** before committing
- ✅ **Use transactions** for data migrations
- ✅ **Backup database** before major changes

### **Don'ts**
- ❌ **Don't modify existing migrations** once deployed
- ❌ **Don't use DROP statements** without careful consideration
- ❌ **Don't skip migration validation**
- ❌ **Don't run migrations manually** in production

## 🔍 Troubleshooting

### **Common Issues**

#### **Migration Validation Failed**
```bash
# Check migration status
mvn flyway:info

# Repair if needed
mvn flyway:repair
```

#### **Out of Order Migrations**
```bash
# Check migration order
mvn flyway:info

# Fix by renaming files with correct version numbers
```

#### **Database Connection Issues**
```bash
# Verify database connection
mvn flyway:validate
```

## 📖 Additional Resources

- [Flyway Documentation](https://flywaydb.org/documentation/)
- [Spring Boot Flyway Integration](https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.data-access.flyway)
- [Database Migration Best Practices](https://flywaydb.org/documentation/concepts/migrations.html)

## 🎯 Migration Status

| Migration | Status | Description |
|-----------|--------|-------------|
| V1 | ✅ Complete | User authentication tables |
| V2 | ✅ Complete | Employee management table |
| V3 | ✅ Complete | Default users and authorities |
| V4 | ✅ Complete | Sample employee data |

---

**Generated for**: Spring Boot Employee Management System  
**Version**: 1.0.0  
**Author**: Mahendra Chaurasia  
**Email**: mahendrachaurasia@gmail.com  
**GitHub**: [@mindae](https://github.com/mindae)

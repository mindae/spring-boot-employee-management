-- =====================================================
-- Flyway Migration: V1__Create_User_Tables.sql
-- Description: Create user authentication tables
-- Author: Mahendra Chaurasia
-- Date: 2025-10-15
-- =====================================================

-- Create APP_USERS table for user authentication
CREATE TABLE APP_USERS (
    ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USERNAME VARCHAR2(45) NOT NULL UNIQUE,
    PASSWORD VARCHAR2(255) NOT NULL,
    ENABLED NUMBER(1) NOT NULL DEFAULT 1,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create APP_AUTHORITIES table for user roles
CREATE TABLE APP_AUTHORITIES (
    ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USERNAME VARCHAR2(45) NOT NULL,
    AUTHORITY VARCHAR2(45) NOT NULL,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT UK_AUTHORITIES_USERNAME_AUTHORITY UNIQUE (USERNAME, AUTHORITY)
);

-- Create foreign key relationship
ALTER TABLE APP_AUTHORITIES 
ADD CONSTRAINT FK_AUTHORITIES_USERNAME 
FOREIGN KEY (USERNAME) REFERENCES APP_USERS(USERNAME);

-- Create indexes for better performance
CREATE INDEX IDX_APP_USERS_USERNAME ON APP_USERS(USERNAME);
CREATE INDEX IDX_APP_AUTHORITIES_USERNAME ON APP_AUTHORITIES(USERNAME);
CREATE INDEX IDX_APP_AUTHORITIES_AUTHORITY ON APP_AUTHORITIES(AUTHORITY);

-- Add comments for documentation
COMMENT ON TABLE APP_USERS IS 'User authentication table';
COMMENT ON TABLE APP_AUTHORITIES IS 'User roles and authorities table';

COMMENT ON COLUMN APP_USERS.ID IS 'Primary key';
COMMENT ON COLUMN APP_USERS.USERNAME IS 'Unique username for login';
COMMENT ON COLUMN APP_USERS.PASSWORD IS 'Encrypted password (BCrypt)';
COMMENT ON COLUMN APP_USERS.ENABLED IS 'Account status (1=enabled, 0=disabled)';
COMMENT ON COLUMN APP_USERS.CREATED_DATE IS 'Account creation timestamp';
COMMENT ON COLUMN APP_USERS.UPDATED_DATE IS 'Last update timestamp';

COMMENT ON COLUMN APP_AUTHORITIES.ID IS 'Primary key';
COMMENT ON COLUMN APP_AUTHORITIES.USERNAME IS 'Username (foreign key to APP_USERS)';
COMMENT ON COLUMN APP_AUTHORITIES.AUTHORITY IS 'Role/authority name (e.g., ROLE_USER, ROLE_ADMIN)';
COMMENT ON COLUMN APP_AUTHORITIES.CREATED_DATE IS 'Authority assignment timestamp';
